<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Editor JSON Glossario Militare</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: #3a4c6c;
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      height: calc(100vh - 40px);
    }

    .header {
      background: #405d90;
      color: white;
      padding: 16px 32px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .header h1 {
      font-size: 24px;
      font-weight: 700;
    }

    .header-buttons {
      display: flex;
      gap: 12px;
    }

    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .btn-primary {
      background: white;
      color: #425F93;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(66, 95, 147, 0.3);
    }

    .btn-secondary {
      background: white;
      color: #425F93;
      border: 2px solid #425F93;
    }

    .btn-secondary:hover {
      background: #425F93;
      color: white;
    }

    .btn-success {
      background: #10b981;
      color: white;
    }

    .btn-success:hover {
      background: #059669;
    }

    .btn-danger {
      background: #ef4444;
      color: white;
    }

    .btn-danger:hover {
      background: #dc2626;
    }

    .content {
      display: flex;
      flex: 1;
      overflow: hidden;
      background: white;
    }

    .sidebar {
      width: 300px;
      background: #f9fafb;
      border-right: 1px solid #e5e7eb;
      display: flex;
      flex-direction: column;
    }

    .sidebar-header {
      padding: 20px;
      border-bottom: 1px solid #e5e7eb;
    }

    .selection-controls {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
    }

    .btn-mini {
      padding: 6px 10px;
      font-size: 12px;
      flex: 1;
    }

    .search-box {
      width: 100%;
      padding: 10px 12px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 14px;
      margin-bottom: 12px;
    }

    .search-box:focus {
      outline: none;
      border-color: #425F93;
    }

    .term-list {
      flex: 1;
      overflow-y: auto;
      padding: 8px;
    }

    .term-item {
      padding: 12px 16px;
      margin-bottom: 4px;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.2s ease;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .term-item:hover {
      background: #f3f4f6;
    }

    .term-item.active {
      background: #dfebff;
      border-left: 4px solid #425F93;
    }

    .term-checkbox {
      width: 18px;
      height: 18px;
      cursor: pointer;
      flex-shrink: 0;
    }

    .term-item-content {
      flex: 1;
      min-width: 0;
    }

    .term-item-acronym {
      font-weight: 700;
      font-size: 15px;
      color: #1f2937;
      margin-bottom: 4px;
    }

    .term-item-full {
      font-size: 12px;
      color: #6b7280;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .editor-panel {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .editor-header {
      padding: 20px 32px;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .editor-title {
      font-size: 20px;
      font-weight: 700;
      color: #1f2937;
    }

    .editor-actions {
      display: flex;
      gap: 8px;
    }

    .editor-content {
      flex: 1;
      overflow-y: auto;
      padding: 32px;
    }

    .form-group {
      margin-bottom: 24px;
    }

    .form-label {
      display: block;
      font-size: 14px;
      font-weight: 600;
      color: #374151;
      margin-bottom: 8px;
    }

    .form-hint {
      display: block;
      font-size: 12px;
      color: #6b7280;
      margin-top: 4px;
      font-style: italic;
    }

    .form-input,
    .form-textarea,
    .form-select {
      width: 100%;
      padding: 10px 12px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 14px;
      font-family: inherit;
    }

    .form-input:focus,
    .form-textarea:focus,
    .form-select:focus {
      outline: none;
      border-color: #425F93;
    }

    .form-textarea {
      min-height: 100px;
      resize: vertical;
    }

    .form-checkbox-group {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px;
      background: #f9fafb;
      border-radius: 8px;
      border: 2px solid #e5e7eb;
    }

    .form-checkbox {
      width: 20px;
      height: 20px;
      cursor: pointer;
    }

    .form-checkbox-label {
      font-size: 14px;
      font-weight: 500;
      color: #374151;
      cursor: pointer;
      user-select: none;
    }

    .form-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      padding: 8px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      min-height: 44px;
    }

    .tag {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 12px;
      background: #dfebff;
      color: #425F93;
      border-radius: 16px;
      font-size: 13px;
      font-weight: 500;
    }

    .tag-remove {
      background: none;
      border: none;
      color: #425F93;
      cursor: pointer;
      font-size: 16px;
      padding: 0;
      line-height: 1;
    }

    .tag-input {
      border: none;
      outline: none;
      flex: 1;
      min-width: 120px;
      padding: 4px;
      font-size: 14px;
    }

    .array-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .array-item {
      display: flex;
      gap: 8px;
      align-items: flex-start;
    }

    .array-item input {
      flex: 1;
    }

    .btn-small {
      padding: 8px 12px;
      font-size: 13px;
    }

    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: #9ca3af;
      text-align: center;
      padding: 40px;
    }

    .empty-state-icon {
      font-size: 64px;
      margin-bottom: 16px;
    }

    .empty-state-text {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }

    @media (max-width: 768px) {
      .content {
        flex-direction: column;
      }

      .sidebar {
        width: 100%;
        max-height: 300px;
      }

      .form-row {
        grid-template-columns: 1fr;
      }
    }

    /* Modal per nuovo termine */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 9999;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .modal-overlay.show {
      opacity: 1;
    }

    .modal {
      background: white;
      border-radius: 12px;
      padding: 32px;
      max-width: 500px;
      width: calc(100% - 40px);
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      transform: scale(0.9);
      transition: transform 0.3s ease;
    }

    .modal-overlay.show .modal {
      transform: scale(1);
    }

    .modal-header {
      margin-bottom: 24px;
    }

    .modal-title {
      font-size: 22px;
      font-weight: 700;
      color: #1f2937;
      margin: 0 0 8px 0;
    }

    .modal-subtitle {
      font-size: 14px;
      color: #6b7280;
      margin: 0;
    }

    .modal-body {
      margin-bottom: 24px;
    }

    .modal-footer {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    }

    .variant-badge {
      display: inline-block;
      background: #fef3c7;
      color: #78350f;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
      margin-left: 6px;
      vertical-align: super;
      font-size: 9px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üìö Editor Glossario Militare</h1>
      <div class="header-buttons">
        <button class="btn btn-danger" onclick="resetEditor()">üîÑ Reset Editor</button>
        <button class="btn btn-secondary" onclick="exportSelected()" id="exportSelectedBtn" style="display: none;">üì§ Esporta Selezionati</button>
        <button class="btn btn-secondary" onclick="importAndMerge()">üîÄ Importa e Unisci</button>
        <button class="btn btn-secondary" onclick="importJSON()">üì• Importa JSON</button>
        <button class="btn btn-primary" onclick="exportJSON()">üì§ Esporta Tutto</button>
      </div>
    </div>

    <div class="content">
      <div class="sidebar">
        <div class="sidebar-header">
          <input type="text" class="search-box" placeholder="Cerca termine..." oninput="filterTerms(this.value)">
          <div class="selection-controls">
            <button class="btn btn-secondary btn-mini" onclick="selectAll()">‚úì Tutti</button>
            <button class="btn btn-secondary btn-mini" onclick="deselectAll()">‚úó Nessuno</button>
          </div>
          <button class="btn btn-success" style="width: 100%;" onclick="createNewTerm()">+ Nuovo Termine</button>
        </div>
        <div class="term-list" id="termList"></div>
      </div>

      <div class="editor-panel">
        <div class="editor-header">
          <div class="editor-title" id="editorTitle">Seleziona un termine</div>
          <div class="editor-actions" id="editorActions" style="display: none;">
            <button class="btn btn-success btn-small" onclick="saveTerm()">üíæ Salva</button>
            <button class="btn btn-danger btn-small" onclick="deleteTerm()">üóëÔ∏è Elimina</button>
          </div>
        </div>
        <div class="editor-content" id="editorContent">
          <div class="empty-state">
            <div class="empty-state-icon">üìñ</div>
            <div class="empty-state-text">Nessun termine selezionato</div>
            <p>Seleziona un termine dalla lista o creane uno nuovo</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <input type="file" id="fileInput" accept=".json" style="display: none;" onchange="handleFileImport(event)">
  <input type="file" id="mergeFileInput" accept=".json" style="display: none;" onchange="handleFileMerge(event)">

  <!-- Modal per nuovo termine -->
  <div id="newTermModal" class="modal-overlay" style="display: none;">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title">Crea Nuovo Termine</h2>
        <p class="modal-subtitle">Inserisci l'acronimo e il significato esteso</p>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">Acronimo / Termine *</label>
          <input type="text" class="form-input" id="modalAcronym" placeholder="es. NATO">
        </div>
        <div class="form-group" style="margin-bottom: 0;">
          <label class="form-label">Significato Esteso *</label>
          <input type="text" class="form-input" id="modalFull" placeholder="es. North Atlantic Treaty Organization">
        </div>
        <div id="variantWarning" style="display: none; margin-top: 16px; padding: 12px; background: #fef3c7; border-left: 4px solid #f59e0b; border-radius: 6px;">
          <p style="margin: 0; font-size: 14px; color: #78350f; font-weight: 600;">‚ö†Ô∏è Questo acronimo esiste gi√† con significato diverso</p>
          <p style="margin: 8px 0 0 0; font-size: 13px; color: #92400e;">Verr√† creato come variante numerata</p>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary btn-small" onclick="closeNewTermModal()">Annulla</button>
        <button class="btn btn-success btn-small" onclick="confirmNewTerm()">Crea Termine</button>
      </div>
    </div>
  </div>

  <script>
    let glossaryData = [];
    let selectedTerms = new Set();
    let currentTerm = null;
    let currentIndex = -1;
    let autoSaveTimeout = null;

    // Carica dati dal localStorage all'avvio
    function loadFromLocalStorage() {
      try {
        const saved = localStorage.getItem('glossaryData');
        if (saved) {
          glossaryData = JSON.parse(saved);
          console.log(`Caricati ${glossaryData.length} termini dal salvataggio locale`);
        }
      } catch (err) {
        console.error('Errore nel caricamento dal localStorage:', err);
      }
    }

    // Salva dati nel localStorage
    function saveToLocalStorage() {
      try {
        localStorage.setItem('glossaryData', JSON.stringify(glossaryData));
        console.log('Dati salvati automaticamente');
      } catch (err) {
        console.error('Errore nel salvataggio al localStorage:', err);
      }
    }

    // Auto-save con debounce
    function triggerAutoSave() {
      if (autoSaveTimeout) {
        clearTimeout(autoSaveTimeout);
      }
      autoSaveTimeout = setTimeout(() => {
        saveToLocalStorage();
      }, 1000); // Salva dopo 1 secondo di inattivit√†
    }

    // Carica dati di esempio
    function loadSampleData() {
      loadFromLocalStorage();
      renderTermList();
    }

    function renderTermList(filter = '') {
      const listEl = document.getElementById('termList');
      const filtered = glossaryData.filter(term => {
        const search = filter.toLowerCase();
        return term.acronym.toLowerCase().includes(search) ||
               term.full.toLowerCase().includes(search);
      });

      if (filtered.length === 0) {
        listEl.innerHTML = '<div style="padding: 20px; text-align: center; color: #9ca3af;">Nessun termine trovato</div>';
        return;
      }

      listEl.innerHTML = filtered.map((term, idx) => {
        const globalIdx = glossaryData.indexOf(term);
        const isSelected = selectedTerms.has(globalIdx);
        const variantBadge = term.variant ? `<span class="variant-badge">${term.variant}</span>` : '';
        return `
          <div class="term-item ${globalIdx === currentIndex ? 'active' : ''}">
            <input type="checkbox" class="term-checkbox" ${isSelected ? 'checked' : ''} onclick="toggleTermSelection(${globalIdx}, event)">
            <div class="term-item-content" onclick="selectTerm(${globalIdx}, event)">
              <div class="term-item-acronym">${term.acronym}${variantBadge}</div>
              <div class="term-item-full">${term.full}</div>
            </div>
          </div>
        `;
      }).join('');

      updateExportButton();
    }

    function toggleTermSelection(index, event) {
      event.stopPropagation();
      
      if (selectedTerms.has(index)) {
        selectedTerms.delete(index);
      } else {
        selectedTerms.add(index);
      }
      
      renderTermList();
    }

    function selectAll() {
      glossaryData.forEach((_, idx) => selectedTerms.add(idx));
      renderTermList();
    }

    function deselectAll() {
      selectedTerms.clear();
      renderTermList();
    }

    function updateExportButton() {
      const btn = document.getElementById('exportSelectedBtn');
      if (selectedTerms.size > 0) {
        btn.style.display = 'block';
        btn.textContent = `üì§ Esporta Selezionati (${selectedTerms.size})`;
      } else {
        btn.style.display = 'none';
      }
    }

    function filterTerms(query) {
      renderTermList(query);
    }

    function selectTerm(index, event) {
      if (event && event.target.classList.contains('term-checkbox')) {
        return;
      }
      
      currentIndex = index;
      currentTerm = glossaryData[index];
      renderTermList();
      renderEditor();
    }

    function createNewTerm() {
      // Apri il modal
      const modal = document.getElementById('newTermModal');
      const acronymInput = document.getElementById('modalAcronym');
      const fullInput = document.getElementById('modalFull');
      const variantWarning = document.getElementById('variantWarning');

      // Reset campi
      acronymInput.value = '';
      fullInput.value = '';
      variantWarning.style.display = 'none';

      // Mostra modal
      modal.style.display = 'flex';
      setTimeout(() => modal.classList.add('show'), 10);

      // Focus sul primo campo
      setTimeout(() => acronymInput.focus(), 100);

      // Listener per controllare varianti
      acronymInput.oninput = checkForVariants;
      fullInput.oninput = checkForVariants;
    }

    function checkForVariants() {
      const acronym = document.getElementById('modalAcronym').value.trim();
      const full = document.getElementById('modalFull').value.trim();
      const variantWarning = document.getElementById('variantWarning');

      if (!acronym || !full) {
        variantWarning.style.display = 'none';
        return;
      }

      // Cerca se esiste gi√† questo acronimo con significato diverso
      const existing = glossaryData.find(term =>
        term.acronym.toLowerCase() === acronym.toLowerCase() &&
        term.full.toLowerCase() !== full.toLowerCase()
      );

      if (existing) {
        variantWarning.style.display = 'block';
      } else {
        variantWarning.style.display = 'none';
      }
    }

    function closeNewTermModal() {
      const modal = document.getElementById('newTermModal');
      modal.classList.remove('show');
      setTimeout(() => {
        modal.style.display = 'none';
      }, 300);
    }

    function confirmNewTerm() {
      const acronym = document.getElementById('modalAcronym').value.trim();
      const full = document.getElementById('modalFull').value.trim();

      if (!acronym || !full) {
        alert('‚ö†Ô∏è Inserisci sia l\'acronimo che il significato esteso');
        return;
      }

      // Controlla se esiste gi√† questo acronimo
      const existingTerms = glossaryData.filter(term =>
        term.acronym.toLowerCase() === acronym.toLowerCase()
      );

      let variant = null;

      if (existingTerms.length > 0) {
        // Controlla se il significato √® identico
        const exactMatch = existingTerms.find(term =>
          term.full.toLowerCase() === full.toLowerCase()
        );

        if (exactMatch) {
          alert('‚ö†Ô∏è Questo termine esiste gi√† con lo stesso significato');
          return;
        }

        // Trova il prossimo numero di variante
        const maxVariant = Math.max(
          ...existingTerms.map(t => t.variant || 1)
        );
        variant = maxVariant + 1;

        // Se i termini esistenti non hanno variant, assegna 1 al primo
        if (existingTerms.some(t => !t.variant)) {
          existingTerms.forEach(t => {
            if (!t.variant) t.variant = 1;
          });
        }
      }

      const newTerm = {
        acronym: acronym,
        full: full,
        description: "",
        category: [],
        status: "Attivo",
        language: "Italiano",
        year: new Date().getFullYear(),
        caseSensitive: false,
        aliases: [],
        nations: [],
        relatedTerms: [],
        images: [],
        videos: [],
        documents: [],
        links: []
      };

      if (variant) {
        newTerm.variant = variant;
      }

      glossaryData.push(newTerm);
      triggerAutoSave();
      closeNewTermModal();
      renderTermList();
      selectTerm(glossaryData.length - 1);
    }

    function renderEditor() {
      if (!currentTerm) return;

      document.getElementById('editorTitle').textContent = currentTerm.acronym;
      document.getElementById('editorActions').style.display = 'flex';
      
      // Collega evento al pulsante elimina
      const deleteBtn = document.querySelector('.editor-actions .btn-danger');
      if (deleteBtn) {
        deleteBtn.onclick = deleteTerm;
      }
      
      // Collega evento al pulsante salva
      const saveBtn = document.querySelector('.editor-actions .btn-success');
      if (saveBtn) {
        saveBtn.onclick = saveTerm;
      }

      const content = document.getElementById('editorContent');
      content.innerHTML = `
        <div class="form-group">
          <label class="form-label">Acronimo *</label>
          <input type="text" class="form-input" id="acronym" value="${currentTerm.acronym}" oninput="autoSaveField()">
          ${currentTerm.variant ? `<span class="form-hint">Variante numero: ${currentTerm.variant}</span>` : ''}
        </div>

        <div class="form-group">
          <label class="form-label">Nome Completo *</label>
          <input type="text" class="form-input" id="full" value="${currentTerm.full}" oninput="autoSaveField()">
        </div>

        <div class="form-group">
          <label class="form-label">Case Sensitive (solo acronimo primario)</label>
          <div class="form-checkbox-group">
            <input type="checkbox" class="form-checkbox" id="caseSensitive" ${currentTerm.caseSensitive ? 'checked' : ''} onchange="autoSaveField()">
            <label class="form-checkbox-label" for="caseSensitive" onclick="document.getElementById('caseSensitive').click()">
              Evidenzia solo se scritto in MAIUSCOLO
            </label>
          </div>
          <span class="form-hint">Quando attivo, l'acronimo verr√† evidenziato solo se scritto completamente in maiuscolo (es: NATO). Gli alias rimangono sempre case-insensitive.</span>
        </div>

        <div class="form-group">
          <label class="form-label">Descrizione</label>
          <textarea class="form-textarea" id="description" oninput="autoSaveField()">${currentTerm.description || ''}</textarea>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Stato</label>
            <select class="form-select" id="status" onchange="autoSaveField()">
              <option value="Attivo" ${currentTerm.status === 'Attivo' ? 'selected' : ''}>Attivo</option>
              <option value="Obsoleto" ${currentTerm.status === 'Obsoleto' ? 'selected' : ''}>Obsoleto</option>
            </select>
          </div>

          <div class="form-group">
            <label class="form-label">Lingua</label>
            <input type="text" class="form-input" id="language" value="${currentTerm.language || ''}" oninput="autoSaveField()">
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">Anno</label>
          <input type="number" class="form-input" id="year" value="${currentTerm.year || ''}" oninput="autoSaveField()">
        </div>

        <div class="form-group">
          <label class="form-label">Categorie (premi Invio per aggiungere)</label>
          <div class="form-tags" id="categoryTags"></div>
        </div>

        <div class="form-group">
          <label class="form-label">Alias (premi Invio per aggiungere)</label>
          <div class="form-tags" id="aliasTags"></div>
          <span class="form-hint">Gli alias vengono sempre evidenziati indipendentemente dal maiuscolo/minuscolo</span>
        </div>

        <div class="form-group">
          <label class="form-label">Paesi (premi Invio per aggiungere)</label>
          <div class="form-tags" id="nationTags"></div>
        </div>

        <div class="form-group">
          <label class="form-label">Termini Correlati (premi Invio per aggiungere)</label>
          <div class="form-tags" id="relatedTags"></div>
        </div>

        <div class="form-group">
          <label class="form-label">Immagini</label>
          <div class="array-list" id="imagesList"></div>
          <button class="btn btn-secondary btn-small" style="margin-top: 8px;" onclick="addImage()">+ Aggiungi Immagine</button>
        </div>

        <div class="form-group">
          <label class="form-label">Video YouTube</label>
          <div class="array-list" id="videosList"></div>
          <button class="btn btn-secondary btn-small" style="margin-top: 8px;" onclick="addVideo()">+ Aggiungi Video</button>
        </div>

        <div class="form-group">
          <label class="form-label">Documenti</label>
          <div class="array-list" id="documentsList"></div>
          <button class="btn btn-secondary btn-small" style="margin-top: 8px;" onclick="addDocument()">+ Aggiungi Documento</button>
        </div>

        <div class="form-group">
          <label class="form-label">Link Utili</label>
          <div class="array-list" id="linksList"></div>
          <button class="btn btn-secondary btn-small" style="margin-top: 8px;" onclick="addLink()">+ Aggiungi Link</button>
        </div>
      `;

      renderTagField('categoryTags', currentTerm.category || []);
      renderTagField('aliasTags', currentTerm.aliases || []);
      renderTagField('nationTags', currentTerm.nations || []);
      renderTagField('relatedTags', currentTerm.relatedTerms || []);
      renderArrayField('imagesList', currentTerm.images || [], 'image');
      renderArrayField('videosList', currentTerm.videos || [], 'video');
      renderArrayField('documentsList', currentTerm.documents || [], 'document');
      renderArrayField('linksList', currentTerm.links || [], 'link');
    }

    function renderTagField(elementId, tags) {
      const container = document.getElementById(elementId);
      container.innerHTML = tags.map((tag, idx) => `
        <span class="tag">
          ${tag}
          <button class="tag-remove" onclick="removeTag('${elementId}', ${idx})">√ó</button>
        </span>
      `).join('') + '<input type="text" class="tag-input" placeholder="Aggiungi..." onkeydown="handleTagInput(event, \'' + elementId + '\')">';
    }

    function handleTagInput(event, elementId) {
      if (event.key === 'Enter' && event.target.value.trim()) {
        event.preventDefault();
        const value = event.target.value.trim();
        
        const fieldMap = {
          categoryTags: 'category',
          aliasTags: 'aliases',
          nationTags: 'nations',
          relatedTags: 'relatedTerms'
        };

        const field = fieldMap[elementId];
        if (!currentTerm[field]) currentTerm[field] = [];
        currentTerm[field].push(value);
        renderTagField(elementId, currentTerm[field]);
        triggerAutoSave();
      }
    }

    function removeTag(elementId, index) {
      const fieldMap = {
        categoryTags: 'category',
        aliasTags: 'aliases',
        nationTags: 'nations',
        relatedTags: 'relatedTerms'
      };

      const field = fieldMap[elementId];
      currentTerm[field].splice(index, 1);
      renderTagField(elementId, currentTerm[field]);
      triggerAutoSave();
    }

    function renderArrayField(elementId, items, type) {
      const container = document.getElementById(elementId);
      container.innerHTML = items.map((item, idx) => {
        if (type === 'image' || type === 'video') {
          return `
            <div class="array-item">
              <input type="text" class="form-input" placeholder="URL" value="${item.url || ''}" onchange="updateArrayItem('${elementId}', ${idx}, 'url', this.value)">
              <input type="text" class="form-input" placeholder="Titolo" value="${item.title || ''}" onchange="updateArrayItem('${elementId}', ${idx}, 'title', this.value)">
              <button class="btn btn-danger btn-small" onclick="removeArrayItem('${elementId}', ${idx})">√ó</button>
            </div>
          `;
        } else {
          return `
            <div class="array-item">
              <input type="text" class="form-input" placeholder="Testo" value="${item.text || ''}" onchange="updateArrayItem('${elementId}', ${idx}, 'text', this.value)">
              <input type="text" class="form-input" placeholder="URL" value="${item.url || ''}" onchange="updateArrayItem('${elementId}', ${idx}, 'url', this.value)">
              <button class="btn btn-danger btn-small" onclick="removeArrayItem('${elementId}', ${idx})">√ó</button>
            </div>
          `;
        }
      }).join('');
    }

    function updateArrayItem(elementId, index, field, value) {
      const fieldMap = {
        imagesList: 'images',
        videosList: 'videos',
        documentsList: 'documents',
        linksList: 'links'
      };

      const arrayField = fieldMap[elementId];
      currentTerm[arrayField][index][field] = value;
      triggerAutoSave();
    }

    function removeArrayItem(elementId, index) {
      const fieldMap = {
        imagesList: 'images',
        videosList: 'videos',
        documentsList: 'documents',
        linksList: 'links'
      };

      const arrayField = fieldMap[elementId];
      currentTerm[arrayField].splice(index, 1);
      renderArrayField(elementId, currentTerm[arrayField], arrayField.slice(0, -1));
      triggerAutoSave();
    }

    function addImage() {
      if (!currentTerm.images) currentTerm.images = [];
      currentTerm.images.push({ url: '', title: '' });
      renderArrayField('imagesList', currentTerm.images, 'image');
      triggerAutoSave();
    }

    function addVideo() {
      if (!currentTerm.videos) currentTerm.videos = [];
      currentTerm.videos.push({ url: '', title: '' });
      renderArrayField('videosList', currentTerm.videos, 'video');
      triggerAutoSave();
    }

    function addDocument() {
      if (!currentTerm.documents) currentTerm.documents = [];
      currentTerm.documents.push({ text: '', url: '' });
      renderArrayField('documentsList', currentTerm.documents, 'document');
      triggerAutoSave();
    }

    function addLink() {
      if (!currentTerm.links) currentTerm.links = [];
      currentTerm.links.push({ text: '', url: '' });
      renderArrayField('linksList', currentTerm.links, 'link');
      triggerAutoSave();
    }

    // Funzione per auto-salvare i campi del form
    function autoSaveField() {
      if (!currentTerm) return;
      
      currentTerm.acronym = document.getElementById('acronym').value;
      currentTerm.full = document.getElementById('full').value;
      currentTerm.description = document.getElementById('description').value;
      currentTerm.status = document.getElementById('status').value;
      currentTerm.language = document.getElementById('language').value;
      currentTerm.year = parseInt(document.getElementById('year').value) || null;
      currentTerm.caseSensitive = document.getElementById('caseSensitive').checked;

      renderTermList();
      triggerAutoSave();
    }

    function saveTerm() {
      autoSaveField();
      alert('‚úÖ Termine salvato con successo!');
    }

    function deleteTerm() {
      console.log('deleteTerm chiamata');
      console.log('currentTerm:', currentTerm);
      console.log('currentIndex:', currentIndex);
      
      if (!currentTerm || currentIndex === -1) {
        console.log('Nessun termine selezionato, uscita');
        alert('‚ö†Ô∏è Nessun termine selezionato');
        return;
      }
      
      if (confirm('Sei sicuro di voler eliminare questo termine?')) {
        console.log('Conferma eliminazione ricevuta');
        
        // Salva l'acronimo per il messaggio di conferma
        const deletedAcronym = currentTerm.acronym;
        console.log('Eliminazione termine:', deletedAcronym);
        
        // Rimuovi il termine
        console.log('glossaryData prima:', glossaryData.length);
        glossaryData.splice(currentIndex, 1);
        console.log('glossaryData dopo:', glossaryData.length);
        
        // Aggiorna gli indici selezionati
        const newSelectedTerms = new Set();
        selectedTerms.forEach(idx => {
          if (idx < currentIndex) {
            newSelectedTerms.add(idx);
          } else if (idx > currentIndex) {
            newSelectedTerms.add(idx - 1);
          }
        });
        selectedTerms = newSelectedTerms;
        console.log('selectedTerms aggiornati:', selectedTerms);
        
        // Reset stato corrente
        currentTerm = null;
        currentIndex = -1;
        
        // Salva immediatamente
        console.log('Salvataggio localStorage...');
        saveToLocalStorage();
        console.log('Salvataggio completato');
        
        // Aggiorna UI
        console.log('Aggiornamento UI...');
        renderTermList();
        document.getElementById('editorContent').innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">üìñ</div>
            <div class="empty-state-text">Nessun termine selezionato</div>
            <p>Seleziona un termine dalla lista o creane uno nuovo</p>
          </div>
        `;
        document.getElementById('editorTitle').textContent = 'Seleziona un termine';
        document.getElementById('editorActions').style.display = 'none';
        console.log('UI aggiornata');
        
        alert(`‚úÖ Termine "${deletedAcronym}" eliminato con successo!`);
      } else {
        console.log('Eliminazione annullata dall\'utente');
      }
    }

    function exportJSON() {
      const json = JSON.stringify(glossaryData, null, 2);
      const blob = new Blob([json], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'glossario_completo.json';
      a.click();
      URL.revokeObjectURL(url);
    }

    function exportSelected() {
      if (selectedTerms.size === 0) {
        alert('‚ö†Ô∏è Nessun termine selezionato');
        return;
      }

      const selectedData = Array.from(selectedTerms)
        .map(idx => glossaryData[idx])
        .filter(term => term !== undefined);

      const json = JSON.stringify(selectedData, null, 2);
      const blob = new Blob([json], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `glossario_selezionati_${selectedData.length}.json`;
      a.click();
      URL.revokeObjectURL(url);

      alert(`‚úÖ Esportati ${selectedData.length} termini`);
    }

    function importJSON() {
      document.getElementById('fileInput').click();
    }

    function handleFileImport(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          glossaryData = JSON.parse(e.target.result);
          selectedTerms.clear();
          currentTerm = null;
          currentIndex = -1;
          saveToLocalStorage();
          renderTermList();
          document.getElementById('editorContent').innerHTML = `
            <div class="empty-state">
              <div class="empty-state-icon">üìñ</div>
              <div class="empty-state-text">Nessun termine selezionato</div>
              <p>Seleziona un termine dalla lista o creane uno nuovo</p>
            </div>
          `;
          document.getElementById('editorTitle').textContent = 'Seleziona un termine';
          document.getElementById('editorActions').style.display = 'none';
          alert('‚úÖ JSON importato con successo!');
        } catch (err) {
          alert('‚ùå Errore nel parsing del JSON: ' + err.message);
        }
      };
      reader.readAsText(file);
    }

    function importAndMerge() {
      document.getElementById('mergeFileInput').click();
    }

    function handleFileMerge(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const importedData = JSON.parse(e.target.result);
          
          if (!Array.isArray(importedData)) {
            alert('‚ùå Il file JSON deve contenere un array di termini');
            return;
          }

          let added = 0;
          let updated = 0;
          let skipped = 0;

          importedData.forEach(importedTerm => {
            // Cerca se il termine esiste gi√† (per acronimo)
            const existingIndex = glossaryData.findIndex(
              term => term.acronym.toLowerCase() === importedTerm.acronym.toLowerCase()
            );

            if (existingIndex !== -1) {
              // Chiedi se sostituire
              const shouldReplace = confirm(
                `Il termine "${importedTerm.acronym}" esiste gi√†.\n\nVuoi sostituirlo con la nuova versione?`
              );

              if (shouldReplace) {
                glossaryData[existingIndex] = importedTerm;
                updated++;
              } else {
                skipped++;
              }
            } else {
              // Aggiungi nuovo termine
              glossaryData.push(importedTerm);
              added++;
            }
          });

          renderTermList();
          saveToLocalStorage();
          
          let message = `‚úÖ Importazione completata!\n\n`;
          if (added > 0) message += `‚ûï Aggiunti: ${added} termini\n`;
          if (updated > 0) message += `üîÑ Aggiornati: ${updated} termini\n`;
          if (skipped > 0) message += `‚è≠Ô∏è Saltati: ${skipped} termini\n`;
          
          alert(message);

        } catch (err) {
          alert('‚ùå Errore nel parsing del JSON: ' + err.message);
        }
      };
      reader.readAsText(file);

      // Reset input
      event.target.value = '';
    }

    // Reset completo dell'editor
    function resetEditor() {
      if (glossaryData.length > 0) {
        // Prima conferma con opzione di esportare
        const wantsExport = confirm('‚ö†Ô∏è ATTENZIONE: Stai per resettare l\'editor.\n\nVuoi esportare i dati prima di procedere?\n\nClicca OK per esportare, Annulla per procedere senza esportare.');
        
        if (wantsExport) {
          // Esporta i dati
          exportJSON();
          // Dopo l'export, chiedi se vuole ancora procedere
          if (!confirm('‚úÖ Dati esportati!\n\nVuoi continuare con il reset dell\'editor?')) {
            return;
          }
        }
        
        // Seconda conferma finale
        if (!confirm('üî¥ CONFERMA FINALE: Tutti i dati verranno eliminati definitivamente dall\'editor.\n\nProcedere con il reset?')) {
          return;
        }
      }
      
      console.log('Reset editor in corso...');
      
      // Cancella tutto
      glossaryData = [];
      selectedTerms.clear();
      currentTerm = null;
      currentIndex = -1;
      
      // Cancella localStorage
      localStorage.removeItem('glossaryData');
      console.log('localStorage cancellato');
      
      // Aggiorna UI
      renderTermList();
      document.getElementById('editorContent').innerHTML = `
        <div class="empty-state">
          <div class="empty-state-icon">üìñ</div>
          <div class="empty-state-text">Editor resettato</div>
          <p>Inizia creando un nuovo termine o importando un JSON</p>
        </div>
      `;
      document.getElementById('editorTitle').textContent = 'Seleziona un termine';
      document.getElementById('editorActions').style.display = 'none';
      
      console.log('Reset completato');
      alert('‚úÖ Editor resettato con successo!');
    }

    // Avviso prima di chiudere la pagina se ci sono dati non esportati
    window.addEventListener('beforeunload', function(e) {
      if (glossaryData.length > 0) {
        const message = 'I tuoi dati sono salvati automaticamente nel browser. Vuoi continuare?';
        e.returnValue = message;
        return message;
      }
    });

    // Inizializza con dati dal localStorage
    loadSampleData();
  </script>
</body>
</html>